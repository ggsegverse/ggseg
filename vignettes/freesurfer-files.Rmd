---
title: "Reading FreeSurfer files"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reading FreeSurfer files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

ggseg includes functions to read FreeSurfer stats files directly into R for plotting.
This avoids manual conversion steps and preserves the data structure ggseg expects.

```{r}
library(ggseg)
library(ggplot2)
library(dplyr)
```

## Reading individual stats files

After running `recon-all`, each subject has a `stats/` folder with parcellation data.
Use `read_freesurfer_stats()` to read these files:
```{r}
subjects_dir <- Sys.getenv("SUBJECTS_DIR")
stats_file <- file.path(subjects_dir, "bert/stats/lh.aparc.stats")

data <- read_freesurfer_stats(stats_file)
data
```

The hemisphere is encoded in the filename (`lh.` or `rh.`).
Add it to the label column for ggseg to match regions correctly:

```{r}
data |>
  mutate(label = paste0("lh_", label)) |>
  ggseg(atlas = dk, mapping = aes(fill = ThickAvg))
```

## Reading stats files for all subjects

`read_atlas_files()` reads stats files across all subjects for a specific atlas.
Use a regular expression to match the files you want:

```{r}
dat <- read_atlas_files(subjects_dir, "aparc.stats$")
dat
```

The `$` ensures you get only files ending with `aparc.stats`, not variants like `aparc.a2009s.stats`.

The function adds hemisphere prefixes automatically:

```{r}
ggseg(dat, mapping = aes(fill = ThickStd))
```

Plot all metrics at once using facets:

```{r, fig.width = 10}
library(tidyr)

dat |>
  pivot_longer(-c(subject, label), names_to = "stat", values_to = "val") |>
  group_by(stat) |>
  ggseg(mapping = aes(fill = val)) +
  facet_wrap(~stat)
```

## Reading FreeSurfer stats tables

FreeSurfer's `aparcstats2table` and `asegstats2table` create summary tables across subjects.
Read these with `read_freesurfer_table()`:

```{r}
table_path <- "path/to/aparc.volume.table"

read_freesurfer_table(table_path)
```

The output has three columns: subject, label, and value.

## Cleaning label suffixes

Stats tables append the measure name to labels (e.g., `lh_bankssts_volume`).
Use the `measure` argument to clean this:

```{r}
dat <- read_freesurfer_table(table_path, measure = "volume")
dat
```

This removes the `_volume` suffix and renames the value column.

## Filtering non-region rows

FreeSurfer tables include summary measures (total volume, ICV) that don't match atlas regions.
Filter these before plotting:

```{r}
dat |>
  filter(grepl("lh|rh", label)) |>
  ggseg(mapping = aes(fill = volume))
```

The `grepl("lh|rh", label)` pattern keeps only hemisphere-specific regions.
