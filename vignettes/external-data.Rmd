---
title: "Plotting external data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plotting external data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, fig.retina = 3, fig.width = 6)
```

To plot your own data on a brain atlas, your data must have at least one column that matches a column in the atlas.
This vignette covers how to prepare your data for ggseg plotting.

```{r start}
library(ggseg)
library(dplyr)
library(ggplot2)
```

## Inspecting atlas columns

Brain atlases have several columns you can match against:

- **region** - human-readable region name
- **label** - raw FreeSurfer label (e.g., "lh_bankssts")
- **hemi** - hemisphere ("left" or "right")
- **view** - view angle ("lateral", "medial", "sagittal", "coronal")

Check available regions:

```{r}
brain_regions(dk)
```

Or labels:

```{r}
brain_labels(dk)
```

## Structuring your data

Create a data frame with at least one column matching the atlas.
Column names and values must match exactly (case-sensitive):

```{r}
some_data <- tibble(
  region = c("superior temporal", "precentral", "lateral orbitofrontal"),
  p = c(.03, .6, .05)
)
some_data
```

## Plotting

Pass your data to ggplot and use `geom_brain()` with the atlas:

```{r}
ggplot(some_data) +
  geom_brain(atlas = dk, mapping = aes(fill = p))
```

The data is automatically joined to the atlas by matching columns.

## Matching on multiple columns

Add more columns to constrain the match.
For hemisphere-specific data, include `hemi`:

```{r}
some_data$hemi <- "left"

ggplot(some_data) +
  geom_brain(atlas = dk, mapping = aes(fill = p))
```

The join now uses both `region` and `hemi`.

## Faceting with groups

When faceting, group your data before passing to ggplot:

```{r}
some_data <- tibble(
  region = rep(c(
    "transverse temporal", "insula", "precentral", "superior parietal"
  ), 2),
  p = sample(seq(0, .5, .001), 8),
  group = c(rep("Young", 4), rep("Old", 4))
)

some_data |>
  group_by(group) |>
  ggplot() +
  geom_brain(atlas = dk, colour = "white", mapping = aes(fill = p)) +
  facet_wrap(~group, ncol = 1) +
  theme(legend.position = "bottom") +
  scale_fill_gradientn(
    colours = c("royalblue", "firebrick", "goldenrod"),
    na.value = "grey"
  )
```

Without `group_by()`, you get an extra facet containing regions without data.

## Pre-merged atlas workflow

For more control over facetting, convert the atlas to a data frame first.
This merges the atlas geometry with region metadata:

```{r}
atlas_df <- as.data.frame(dk)
names(atlas_df)
```

Then join your data and use `geom_sf()` directly:

```{r}
some_data <- tibble(
  region = c("superior temporal", "precentral", "lateral orbitofrontal"),
  p = c(.03, .6, .05)
)

atlas_df |>
  left_join(some_data, by = "region") |>
  ggplot() +
  geom_sf(aes(fill = p), colour = "white") +
  facet_grid(hemi ~ view) +
  theme_void()
```

This gives you full control over faceting by any column in the atlas.

## Common issues

**Regions don't show up**: Check that your region names match exactly.
Use `brain_regions(dk)` to see valid names.

**Wrong hemisphere**: If your data is hemisphere-specific, include a `hemi` column with values "left" or "right".

**Extra facet panels**: Group your data by faceting variables before calling ggplot.
