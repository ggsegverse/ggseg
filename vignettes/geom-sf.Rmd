---
title: "Using atlases with geom_sf"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using atlases with geom_sf}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6
)
```

`geom_brain()` handles atlas data automatically, but this limits integration with other sf geoms like `geom_sf_label()`.
This vignette shows an alternative workflow: pre-join your data with the atlas, then use standard sf geoms.

```{r setup}
library(ggseg)
library(ggplot2)
library(dplyr)
```

## When to use this workflow

Use the sf workflow when you need:

- Region labels with `geom_sf_label()` or `geom_sf_text()`
- Repelled labels with `ggrepel::geom_sf_label_repel()`
- Other sf geoms layered on the brain
- Full control over the simple features data

## Checking atlas compatibility

Brain atlases contain simple features geometry in their `data` slot:

```{r}
dk$data
```

The `geometry` column holds the polygon data.

## Joining data with brain_join

Use `brain_join()` to merge your data with the atlas while preserving atlas structure:

```{r}
some_data <- tibble(
  region = c(
    "transverse temporal", "insula", "precentral", "superior parietal"
  ),
  p = sample(seq(0, .5, .001), 4)
)

some_data |>
  brain_join(dk)
```

The result is a standard sf object.

## Plotting with geom_sf

Plot the joined data using `geom_sf()`:

```{r}
some_data |>
  brain_join(dk) |>
  ggplot() +
  geom_sf(aes(fill = p))
```

## Repositioning slices

Use `reposition_brain()` (not `position_brain()`) to rearrange slices before plotting:

```{r}
some_data |>
  brain_join(dk) |>
  reposition_brain(hemi ~ side) |>
  ggplot() +
  geom_sf(aes(fill = p))
```

The function takes the same formula syntax as `position_brain()`.

## Adding labels

Now you can layer sf geoms like labels:

```{r}
some_data |>
  brain_join(dk) |>
  reposition_brain(hemi ~ side) |>
  ggplot(aes(fill = p)) +
  geom_sf(show.legend = FALSE) +
  geom_sf_label(
    aes(label = ifelse(!is.na(p), region, NA)),
    alpha = .8,
    show.legend = FALSE
  )
```

For non-overlapping labels, use `ggrepel::geom_sf_label_repel()`.

## Faceting with groups

Group your data before calling `brain_join()`:

```{r}
some_data <- tibble(
  region = rep(c(
    "transverse temporal", "insula", "precentral", "superior parietal"
  ), 2),
  p = sample(seq(0, .5, .001), 8),
  group = c(rep("A", 4), rep("B", 4))
)

some_data |>
  group_by(group) |>
  brain_join(dk) |>
  reposition_brain(hemi ~ side) |>
  ggplot(aes(fill = p)) +
  geom_sf(show.legend = FALSE) +
  facet_wrap(~group)
```

The grouping ensures each facet gets the complete atlas.
