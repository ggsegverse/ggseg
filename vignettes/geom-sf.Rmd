---
title: "Working with geom_sf directly"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with geom_sf directly}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6
)
```

`geom_brain()` handles data joining and positioning automatically, which
covers most use cases. But because it owns the data pipeline, you can't
easily layer other sf geoms on top -- things like `geom_sf_label()` or
`geom_sf_text()` need direct access to the sf data.

This vignette shows how to work with brain atlases as plain sf objects,
giving you full control at the cost of a few extra lines.

```{r setup}
library(ggseg)
library(ggplot2)
library(dplyr)
```

## When you'd want this

Use the sf workflow when you need to:

- Add region labels with `geom_sf_label()` or `geom_sf_text()`
- Use `ggrepel::geom_label_repel()` for non-overlapping labels
- Layer other sf geoms on the brain
- Have full control over the data before it reaches ggplot

For everything else, `geom_brain()` is simpler.

## Getting atlas data as sf

A brain atlas stores its geometry in the `data` slot. Convert to a plain
data frame to see all the columns:

```{r}
dk$data
```

The `geometry` column holds the polygons. This is a standard sf object, so
any sf-compatible tool works with it.

## Joining your data

Use `brain_join()` to merge your data with the atlas. It preserves the sf
geometry and handles column detection:

```{r}
some_data <- tibble(
  region = c(
    "transverse temporal", "insula", "precentral", "superior parietal"
  ),
  p = sample(seq(0, .5, .001), 4)
)

some_data |>
  brain_join(dk)
```

The result is a standard sf object you can pass to `geom_sf()`.

## Plotting with geom_sf

```{r}
some_data |>
  brain_join(dk) |>
  ggplot() +
  geom_sf(aes(fill = p))
```

## Repositioning views

With `geom_brain()`, you'd use `position_brain()`. In the sf workflow, use
`reposition_brain()` instead -- it transforms the geometry directly:

```{r}
some_data |>
  brain_join(dk) |>
  reposition_brain(hemi ~ view) |>
  ggplot() +
  geom_sf(aes(fill = p))
```

Same formula syntax, same results.

## Adding labels

This is the main reason to use the sf workflow. Once you have repositioned
sf data, you can layer any sf geom:

```{r}
some_data |>
  brain_join(dk) |>
  reposition_brain(hemi ~ view) |>
  ggplot(aes(fill = p)) +
  geom_sf(show.legend = FALSE) +
  geom_sf_label(
    aes(label = ifelse(!is.na(p), region, NA)),
    alpha = .8,
    show.legend = FALSE
  )
```

For crowded plots, `ggrepel::geom_label_repel()` avoids overlapping labels.

## Faceting with grouped data

In the sf workflow, faceting requires `group_by()` before `brain_join()`.
The grouping tells the join to replicate the atlas for each group:

```{r}
some_data <- tibble(
  region = rep(c(
    "transverse temporal", "insula", "precentral", "superior parietal"
  ), 2),
  p = sample(seq(0, .5, .001), 8),
  group = c(rep("A", 4), rep("B", 4))
)

some_data |>
  group_by(group) |>
  brain_join(dk) |>
  reposition_brain(hemi ~ view) |>
  ggplot(aes(fill = p)) +
  geom_sf(show.legend = FALSE) +
  facet_wrap(~group)
```

This step is only needed in the sf workflow. `geom_brain()` handles atlas
replication automatically (see [Plotting external data](external-data.html)).
