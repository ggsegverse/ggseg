---
title: "Plotting brain atlases with geom_brain"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plotting brain atlases with geom_brain}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6
)
```

ggseg plots brain atlases as ggplot2 layers using simple features geometry.
The main function, `geom_brain()`, works like any other ggplot geom but handles the atlas data automatically.

```{r setup}
library(ggseg)
library(ggplot2)
```

## The brain_atlas class

Brain atlases are stored in a `brain_atlas` object with four components:

```{r}
dk$atlas
dk$type
dk$palette
dk$data
```

The `palette` is optional.
The `data` contains simple features geometry in the `geometry` column.

Call `plot()` on an atlas for a quick overview:

```{r}
plot(dk)
```

The print method shows atlas metadata:

```{r}
dk
```

Two helper functions extract region and label names:

```{r}
brain_regions(dk)
brain_labels(dk)
```

## Basic plotting

`geom_brain()` plots the atlas with regions filled by the `region` column by default:

```{r}
ggplot() +
  geom_brain(atlas = dk)
```

## Positioning slices

The `position_brain()` function controls slice arrangement.
It accepts a formula (like `facet_grid`) or a character vector:

```{r}
ggplot() +
  geom_brain(atlas = dk, position = position_brain(hemi ~ view))
```

Reorder slices with a character vector:

```{r}
ggplot() +
  geom_brain(
    atlas = dk,
    position = position_brain(c(
      "right lateral", "right medial",
      "left lateral", "left medial"
    ))
  )
```

## Filtering hemispheres and views

Show only specific hemispheres or views:

```{r}
ggplot() +
  geom_brain(atlas = dk, view = "lateral")

ggplot() +
  geom_brain(atlas = dk, hemi = "left")
```

For subcortical atlases, use valid view names from `brain_views()`:

```{r}
brain_views(aseg)

ggplot() +
  geom_brain(atlas = aseg, view = "coronal_3")
```

## Plotting your data

Provide data with at least one column matching the atlas (typically `region` or `label`).
The geom merges your data with the atlas automatically:

```{r}
library(dplyr)

some_data <- tibble(
  region = c(
    "transverse temporal", "insula", "precentral", "superior parietal"
  ),
  p = sample(seq(0, .5, .001), 4)
)

ggplot(some_data) +
  geom_brain(
    atlas = dk,
    position = position_brain(hemi ~ view),
    aes(fill = p)
  ) +
  scale_fill_viridis_c(option = "cividis", direction = -1) +
  theme_void()
```

## Faceting

For faceted plots, group your data before passing to ggplot:

```{r}
some_data <- tibble(
  region = rep(c(
    "transverse temporal", "insula", "precentral", "superior parietal"
  ), 2),
  p = sample(seq(0, .5, .001), 8),
  group = c(rep("A", 4), rep("B", 4))
)

some_data |>
  group_by(group) |>
  ggplot() +
  geom_brain(
    atlas = dk,
    position = position_brain(hemi ~ view),
    aes(fill = p)
  ) +
  facet_wrap(~group)
```

Without grouping, ggplot creates an extra facet for atlas regions without data.

## Categorical regions

To highlight specific regions with their atlas colours:

```{r}
data <- data.frame(
  region = brain_regions(dk)[1:3],
  reg_col = brain_regions(dk)[1:3]
)

ggplot(data) +
  geom_brain(atlas = dk, aes(fill = reg_col)) +
  scale_fill_brain2(dk$palette[data$region])
```

The trick: one column for merging (`region`), another for the fill aesthetic (`reg_col`).

## Scales and themes

Built-in scales use the atlas colour palette:

```{r, eval=FALSE}
ggplot() +
  geom_brain(atlas = dk, aes(fill = region)) +
  scale_fill_brain("dk")
```

Built-in themes remove axes and grids:

```{r, eval=FALSE}
ggplot() +
  geom_brain(atlas = dk) +
  theme_brain()
```

## 2D and 3D from the same atlas

The `brain_atlas` class works with both ggseg and ggseg3d.
The same atlas object produces 2D polygon plots with ggseg and interactive 3D visualizations with ggseg3d:

```{r, eval=FALSE}
library(ggseg3d)

plot(dk)

ggseg3d(atlas = dk)
```

## Finding atlases

ggseg ships with two atlases: `dk` (Desikan-Killiany cortical) and `aseg` (subcortical).
Many more are available through the [ggseg r-universe](https://ggseg.r-universe.dev):

```{r, eval=FALSE}
install.packages("ggsegYeo2011", repos = "https://ggseg.r-universe.dev")
```

See `ggsegExtra::ggseg_atlas_repos()` for a complete list.
